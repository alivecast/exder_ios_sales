<!DOCTYPE html>
<html>
	<head>
		<title></title>

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no;" />
		<meta charset="utf-8">

		<!-- iPad/iPhone specific css below, add after your main css >
		<link rel="stylesheet" media="only screen and (max-device-width: 1024px)" href="ipad.css" type="text/css" />
		<link rel="stylesheet" media="only screen and (max-device-width: 480px)" href="iphone.css" type="text/css" />
		-->
         <link rel="stylesheet" href="css/iphone.css" type="text/css" />
                    
        <script type="text/javascript" charset="utf-8" src="js/jquery-1.8.2.min.js"></script>
                    
        <script type="text/javascript" charset="utf-8" src="js/base64.js"></script>
        <script type="text/javascript" charset="utf-8" src="js/aes.js"></script>
        <script type="text/javascript" charset="utf-8" src="js/main.js"></script>
            
        <script type="text/javascript" charset="utf-8" src="js/cordova-1.5.0.js"></script>
        
        
        <script type="text/javascript">
            $( document ).bind( "mobileinit", function() {
                // jQuery Mobile フレームワークの設定変更は、ここで行なってください！
                $.support.cors = true;
                $.mobile.allowCrossDomainPages = true;
            });

			$(document).ready(function(){
				document.addEventListener("deviceready", onDeviceReady, false);
			});

			function onDeviceReady() {
				// Test
				// var fname = 'setting';
				// delFile(fname);
				
				// URLの取得
				$.ajax({
					type: "POST",
					url: "http://exorder.jp/app/send_init.php",
					data:"id1=alivecast&id2=sugoi",
					success: function(rdata){
                        console.log("正常にテキストを読み込みました。 https: " + rdata.https);
						onDeviceCheck(rdata);
					},
                    error: function(data) {
                    message = '通信が混み合っているか、通信環境がよくないため、もうしばらくお待ちしてから、接続しなおしてください。';
                    title = 'サーバーと通信できませんでした';
                    button = 'OK';
                    navigator.notification.alert(message, alertCallBack(), title, button);
                    return false;
                    }
				});
			}

			// alertCallBack -----------------------------------------------------------------------
			function alertCallBack() {
                $("#loading").css("display","none");
                $("#top").css("display","block");
			}
            
			function onDeviceCheck(rdata) {
				console.log("Setting");
                
				var fname = 'setting';
				getFile(fname,onGetSettingOK,onGetSettingNG);

				function onGetSettingOK(json){
					console.log("onGetSettingOK");
                    
					json['http']  = rdata.http;
					json['https'] = rdata.https;
                    json['url']   = rdata.url;
                    if(json.uid){
                    	if(json.uid == 0){
                    		initSettingFile(json);
                    	}else{

							updateSettingFile(json);
						}
                    }else{
						initSettingFile(json);
                    }
                }
                
                function onGetSettingNG(){
                    console.log("onGetSettingNG");
					initSettingFile(rdata);
                }

				function initSettingFile(data){
					message = 'はじめに、ログイン情報の設定を行ってください。';
                    title = '重要';
                    button = 'OK';
                    navigator.notification.alert(message, alertCallBack(), title, button);
                    
					var datalist = {
						uid: "0",
						act_key: "0",
						app_ver: "0100",
						app_code: "fujichrome_velvia50",
						url: data.url,
						http: data.http,
						https: data.https
					}
				    // ファイル処理
				    var fname = 'setting';
					setFile(fname, datalist);
					
					location.href="setting_init.html";
					return false;
                }

                function updateSettingFile(udata){
					var datalist = udata;
				    // ファイル処理
				    var fname = 'setting';
					setFile(fname, datalist);
					
					location.href="barcode.html";
					return false;
                }
                function alertCallBack(){
                }

			}

		</script>
    	<script type="text/javascript" charset="utf-8" src="js/jquery.mobile-1.2.0.min.js"></script>

	</head>

	<body>
		<div data-role="page" data-add-back-btn="false" data-theme="z">

			<div class="cont_itemDetail" data-role="content" id="loading" style="text-align:center;top:50px">
				<h1>Please Waiting...</h1>
				<div >
					<img src="images/loading_bar_or.gif" />
				</div>
			</div>
            
			<div class="cont_itemDetail" data-role="content" id="top" style="display:none;">
				<input type="button" class="btn_next" value="再接続" onclick="location.href='index.html'"/>
			</div>
            

		</div>
        
	</body>
</html>

